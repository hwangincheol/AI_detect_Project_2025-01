<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ë™ì˜ìƒ íƒì§€</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    .btn.active {
      background-color: #0d6efd !important;
      color: white !important;
      border-color: #0d6efd !important;
    }
    body {
        background-color: #121212;
        color: white;
        margin-bottom: 50px;
    }
    .container {
        max-width: 1400px;
        max-height: 90vh;
        margin-top: 50px;
    }
    video {
        margin-top: 20px;
        width: 100%;
        border-radius: 10px;
        border: 2px solid #007bff;
    }
    #capturedImage {
        margin-top: 20px;
        max-width: 100%;
        border-radius: 10px;
        border: 2px solid #007bff;
    }
    .col-left, .col-right {
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .col-left {
        padding-right: 20px;
    }
    .col-right {
        padding-left: 20px;
    }
    button {
        width: 100%;
        margin-top: 20px;
    }
    #capturedDiv {
        display: none;
    }
    .button-container {
      display: flex;
      justify-content: space-between;  /* ë²„íŠ¼ë“¤ ì‚¬ì´ì— ê³µê°„ì„ ê· ë“±í•˜ê²Œ ë°°ì¹˜ */
      gap: 10px;  /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
    }
  </style>
</head>
<body>

<nav class="navbar navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand mx-auto fs-3 fw-bold" href="#">ğŸŒŠ ë¶€ìœ ë¬¼ íƒì§€ ì›¹ì‚¬ì´íŠ¸</a>
  </div>
</nav>
<!-- íƒì§€ ëª¨ë“œ ì„ íƒ ë²„íŠ¼ -->
<div class="container mt-3">
  <div class="d-flex justify-content-center gap-3">
    <a href="/photo" class="btn btn-outline-light btn-lg fw-bold" id="photoBtn">
      ğŸ“· ì‚¬ì§„ íƒì§€
    </a>
    <a href="/video" class="btn btn-outline-light btn-lg fw-bold" id="videoBtn">
      ğŸ¬ ë™ì˜ìƒ íƒì§€
    </a>
  </div>
</div>

<div class="container">
  <div class="row">
    <div class="col-md-6 col-left">
      <h2 class="mb-4 fw-bold text-white">ğŸ¬ ë™ì˜ìƒ í”Œë ˆì´ì–´</h2>
      <div class="mt-4">
        <label for="videoUpload" class="form-label fw-bold text-white">ğŸ¥ ë™ì˜ìƒ íŒŒì¼ ì„ íƒ</label>
        <input type="file" class="form-control" id="videoUpload" accept="video/mp4, video/webm, video/ogg">
      </div>
    </div>
    <div class="col-md-6 col-right">
      <h2 class="mb-4 fw-bold text-white">ğŸ” íƒì§€ ê²°ê³¼</h2>
      <div class="mt-4">
        <h4 style="margin-top: 32px;" class="mt-4 fw-bold text-white">íƒì§€ëœ ì´ë¯¸ì§€ :</h4>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6 col-left">
      <div>
        <video id="videoPlayer" controls></video>
        <div class="button-container mt-3"> <!-- ë²„íŠ¼ë“¤ì„ ê°ì‹¸ëŠ” div -->
          <button class="btn btn-primary fw-bold text-white" id="captureButton">ìº¡ì²˜ íƒì§€</button>
          <button class="btn btn-success fw-bold text-white" id="playButton">ë™ì˜ìƒ íƒì§€</button>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-right">
      <div id="capturedDiv">
        <img id="capturedImage" src="" alt="ìº¡ì²˜ëœ ì´ë¯¸ì§€" />
        <button class="btn btn-secondary fw-bold text-white" id="downloadButton" style="margin-top: 42px;">ë‹¤ìš´ë¡œë“œ</button>
      </div>
    </div>
  </div>

</div>

<canvas id="canvas" style="display: none;"></canvas>

<script>
  const currentPath = window.location.pathname;

  if (currentPath === "/photo") {
      document.getElementById("photoBtn").classList.add("active");
  } else if (currentPath === "/video") {
      document.getElementById("videoBtn").classList.add("active");
  }

  let intervalId;  // ë™ì˜ìƒì²˜ëŸ¼ ë³´ê¸° ë²„íŠ¼ì„ ìœ„í•œ ì¸í„°ë²Œ ID

  $("#videoUpload").on("change", function (event) {
    $("#videoPlayer")[0].src = "";  // ìƒˆ ë™ì˜ìƒ ë¡œë“œ ì „ ì´ì „ ë™ì˜ìƒ ì´ˆê¸°í™”
    $("#capturedImage").attr("src", "");  // ìº¡ì²˜ëœ ì´ë¯¸ì§€ ì´ˆê¸°í™”
    $("#capturedDiv").hide();  // ìº¡ì²˜ëœ ì´ë¯¸ì§€ ì˜ì—­ ìˆ¨ê¸°ê¸°
    clearInterval(intervalId); // ì´ì „ì— ì‹¤í–‰ ì¤‘ì¸ ìº¡ì²˜ ê°„ê²©ì„ ì¤‘ì§€

    const file = event.target.files[0];
    const fileExtension = file.name.split('.').pop().toLowerCase();

    const allowedExtensions = ["mp4", "webm", "ogg"];
    if (!allowedExtensions.includes(fileExtension)) {
        alert("âŒ ì§€ì›ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤! (MP4, WebM, Oggë§Œ ê°€ëŠ¥)");
        $(this).val("");
        return;
    }

    const videoURL = URL.createObjectURL(file);
    $("#videoPlayer").attr("src", videoURL);

    $("#videoPlayer")[0].play().catch(function (error) {
        alert("âŒ ë™ì˜ìƒì„ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        $("#videoPlayer")[0].src = "";  // ìƒˆ ë™ì˜ìƒ ë¡œë“œ ì „ ì´ì „ ë™ì˜ìƒ ì´ˆê¸°í™”
        $("#capturedImage").attr("src", "");  // ìº¡ì²˜ëœ ì´ë¯¸ì§€ ì´ˆê¸°í™”
        $("#capturedDiv").hide();  // ìº¡ì²˜ëœ ì´ë¯¸ì§€ ì˜ì—­ ìˆ¨ê¸°ê¸°
        clearInterval(intervalId); // ì´ì „ì— ì‹¤í–‰ ì¤‘ì¸ ìº¡ì²˜ ê°„ê²©ì„ ì¤‘ì§€
    });
  });

  $("#captureButton").on("click", function() {
    clearInterval(intervalId);
    const video = document.getElementById("videoPlayer");

    if (!video.src || video.src === window.location.href) {
        alert("âŒ ë™ì˜ìƒì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!");
        return;
    }

    const canvas = document.getElementById("canvas");
    const context = canvas.getContext("2d");

    // ë¹„ë””ì˜¤ì˜ í¬ê¸° ëŒ€ë¹„ ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì • (í•´ìƒë„ ì ˆë°˜ìœ¼ë¡œ ì¶•ì†Œ)
    canvas.width = video.videoWidth / 2;
    canvas.height = video.videoHeight / 2;

    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Blob í˜•íƒœë¡œ ìº¡ì²˜ëœ ì´ë¯¸ì§€ ìƒì„±
    canvas.toBlob(function(blob) {
        var formData = new FormData();
        formData.append("message", "image capture");

        // ì´ë¯¸ì§€ë¥¼ JPEG í¬ë§·ìœ¼ë¡œ ì••ì¶•í•˜ì—¬ íŒŒì¼ ì „ì†¡ (í’ˆì§ˆ: 0.7)
        formData.append("file", blob, "captured-image.jpg");

        fetch('http://localhost:80/java_service', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log('ì„œë²„ ì‘ë‹µ:', data);

            // ì˜ˆì‹œ: ì„œë²„ ì‘ë‹µ ì²˜ë¦¬
            if (data && data.image) {
                // ì„œë²„ì—ì„œ ë°›ì€ ì´ë¯¸ì§€ë¥¼ í™”ë©´ì— í‘œì‹œ
                $("#capturedImage").attr("src", "data:image/png;base64," + data.image);
                $("#capturedDiv").show();
            } else {
                alert("ì´ë¯¸ì§€ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("ì„œë²„ì™€ì˜ ì—°ê²°ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    }, "image/jpeg", 0.7);  // JPEG í˜•ì‹ìœ¼ë¡œ ì••ì¶• (í’ˆì§ˆ: 70%)
  });

  // ë™ì˜ìƒì²˜ëŸ¼ ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ (1ì´ˆë§ˆë‹¤ ìº¡ì²˜)
  $("#playButton").on("click", function() {
    const video = document.getElementById("videoPlayer");

    if (!video.src || video.src === window.location.href) {
        alert("âŒ ë™ì˜ìƒì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!");
        return;
    }

    // 1ì´ˆë§ˆë‹¤ ìº¡ì²˜
    intervalId = setInterval(function() {
        const canvas = document.getElementById("canvas");
        const context = canvas.getContext("2d");

        // ìº¡ì²˜í•  í•´ìƒë„ë¥¼ ì ˆë°˜ìœ¼ë¡œ ì¤„ì—¬ì„œ ì„±ëŠ¥ ê°œì„ 
        canvas.width = video.videoWidth / 2;
        canvas.height = video.videoHeight / 2;

        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Blob í˜•íƒœë¡œ ìº¡ì²˜ëœ ì´ë¯¸ì§€ ìƒì„±
        canvas.toBlob(function(blob) {
            var formData = new FormData();
            formData.append("message", "image capture");

            // ì´ë¯¸ì§€ë¥¼ JPEG í˜•ì‹ìœ¼ë¡œ ì••ì¶•í•˜ì—¬ ì „ì†¡ (í’ˆì§ˆ: 0.7)
            formData.append("file", blob, "captured-image.jpg");

            fetch('http://localhost:80/java_service', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('ì„œë²„ ì‘ë‹µ:', data);

                // ì˜ˆì‹œ: ì„œë²„ ì‘ë‹µ ì²˜ë¦¬
                if (data && data.image) {
                    $("#capturedImage").attr("src", "data:image/png;base64," + data.image);
                    $("#capturedDiv").show();
                } else {
                    alert("ì´ë¯¸ì§€ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("ì„œë²„ì™€ì˜ ì—°ê²°ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        }, "image/jpeg", 0.7);  // JPEG í˜•ì‹ìœ¼ë¡œ ì••ì¶• (í’ˆì§ˆ: 70%)
    }, 1000);  // 1ì´ˆë§ˆë‹¤ ì‹¤í–‰
  });

  // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì‹œ
  $("#downloadButton").on("click", function() {
    const dataURL = $("#capturedImage").attr("src");
    if (!dataURL) return;

    if (confirm("ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        const link = document.createElement("a");
        link.href = dataURL;
        link.download = "download_image.png";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
  });

  // ë™ì˜ìƒì´ ëë‚˜ë©´ ìë™ìœ¼ë¡œ ìº¡ì²˜ê°€ ë©ˆì¶”ë„ë¡ í•˜ê¸°
  $("#videoPlayer").on("ended", function() {
    clearInterval(intervalId);
  });
</script>

</body>
</html>